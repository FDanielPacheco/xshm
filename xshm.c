/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Introduction
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************//**
 * @file      xshm.c
 * 
 * @version   1.0
 *
 * @date      03-05-2025
 *
 * @brief     A C library providing convenient wrappers around POSIX shared memory (shm_open, mmap, shm_unlink) for easier IPC. 
 *  
 * @author    Fábio D. Pacheco, 
 * @email     fabio.d.pacheco@inesctec.pt or pacheco.castro.fabio@gmail.com
 *
 * @copyright Copyright (c) [2025] [Fábio D. Pacheco]
 * 
 * @note      Manuals:
 * 
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Libraries
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <errno.h>
#include <unistd.h>

#include "xshm.h"

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * Functions
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
void * 
shm_open2( const char * path, const size_t size, int oflag, mode_t mode ){
  if( !path || !size ){
    errno = EINVAL;
    return NULL;
  }

  int fd = shm_open( path, oflag, mode );
  if( -1 == fd )
    return NULL;
  
  if( -1 == ftruncate( fd, (long int) size ) ){
    close( fd );
    return NULL;  
  }

  void * buf = mmap( NULL, 
    size, 
    PROT_READ | PROT_WRITE, 
    MAP_SHARED,
    fd,
    0 );
  
  if( MAP_FAILED == buf ){
    close( fd );
    return NULL;
  }
  
  close( fd );

  return buf;  
}

/**************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
int 
shm_close2( const char * path, void * mem, const size_t size ){
  if( !mem || !size ){
    errno = EINVAL;
    return -1;
  }
  
  if( -1 == munmap( mem, size ) )
    return -1;
  
  if( NULL != path )
    shm_unlink( path );
  
  return 0;
}

/***************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************
 * End file
 **************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
